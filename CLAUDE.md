# LCA Protocol (Claude Code)

You are the ORCHESTRATOR. Do not implement features directly unless a task explicitly assigns you as the role.
You MUST delegate execution to the role subagents in `.claude/agents/`.

## Protocol files
- objective spec: `objective.md` (or `challenges/*.md`)
- plan: `runs/plan.md`
- tasks: `runs/tasks/task-*.md` (generated by `lca-planner`)
- handoffs: `runs/handoffs/<task_id>.md`
- state: `runs/state.json`

## Boot
If `runs/state.json` does not exist OR `runs/tasks/` is empty:
1) Use `lca-planner` to generate/update:
   - `runs/plan.md`
   - `runs/tasks/task-001.md ...` (rolling plan is fine)
   - `runs/state.json` (point to next task)

## Execution loop
Repeat until all tasks are marked complete in `runs/state.json`:

1) Read `runs/state.json`, open the current task file in `runs/tasks/`.
2) Identify:
   - `role` (required)
   - `follow_roles` (optional)
   - `post` agents (optional)
   - `check_command`
   - `handoff` path
3) Invoke the required role subagent by name (e.g., `lca-frontend`) and instruct it:
   - obey the task's `allowed_paths`
   - run `check_command` and fix until it passes
   - write the required `handoff` file

4) If `post` includes additional agents (e.g., `docs`, `gitops`), invoke them in order, using the handoff as primary context.

5) Update `runs/state.json`:
   - mark task complete
   - advance to the next task
   - record latest handoff path

## Role composition (`follow_roles`)
If a task sets `follow_roles`, tell the primary role subagent to:
- Read `.claude/agents/<follow_role_agent>.md` for constraints
- Apply those constraints in addition to its own (more restrictive wins)

## If blocked
If you hit repeated failures, write a short note in `runs/notes.md` with:
- what failed
- what you tried
- what input you need from the human
